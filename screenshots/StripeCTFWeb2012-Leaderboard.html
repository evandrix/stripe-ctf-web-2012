<!DOCTYPE html>
<!-- saved from url=(0031)https://stripe-ctf.com/levels/8 -->
<html lang="en" class="wf-futurapt-i4-active wf-futurapt-i7-active wf-futurapt-n7-active wf-futurapt-n4-active wf-active" __screen_capture_need_hook_scroll_value__="false"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Stripe: Capture the Flag</title>
    <link rel="stylesheet" href="https://stripe-ctf.com/styles.css?d=12224" media="screen">
    <link rel="shortcut icon" href="http://stripe-ctf.com/favicon.ico">
    <script type="text/javascript" async="" src="./StripeCTFWeb2012-Leaderboard_files/ga.js"></script><script type="text/javascript" src="./StripeCTFWeb2012-Leaderboard_files/jquery.min.js"></script>
    <script type="text/javascript" src="./StripeCTFWeb2012-Leaderboard_files/weg5vop.js"></script>
    <style type="text/css">.tk-futura-pt{font-family:"futura-pt",sans-serif;}</style><link rel="stylesheet" href="https://use.typekit.net/c/8eb17c/futura-pt:n7:i7:n4:i4.SH5:F:2,SH6:F:2,SH8:F:2,SH9:F:2/d?3bb2a6e53c9684ffdc9a9bf61d5b2a62d6138ae381e419350a9e4b7132f7f328128f61317c936ceec5364f60ea2146603d04978ebfa2ee589600198ac1fb95ffd1904e7f9c2c7e9889b1b1593abb52197fb20460c11480205b0e674bcc31fa0fa623c41e747a1ed023ed0b"><script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34293016-1']);
  _gaq.push(['_setDomainName', 'stripe-ctf.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<link type="text/css" rel="stylesheet" href="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/style.css"><script type="text/javascript" charset="utf-8" src="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/page_context.js"></script></head>
  <body class="tk-futura-pt logged-in" screen_capture_injected="true">

  <div id="header">
    <h1><a href="https://stripe-ctf.com/">Stripe: Capture the Flag</a></h1>
  </div>

    <ul id="navigation">
        <li><a href="https://stripe-ctf.com/" class="unselected">Home</a></li>
        <li><a href="https://stripe-ctf.com/progress" class="unselected">Progress</a></li>
        <li><a href="https://stripe-ctf.com/leaderboard" class="unselected">Leaderboard</a></li>
        <li><a href="https://stripe-ctf.com/settings" class="unselected">Settings</a></li>
      <li>
        <form action="https://stripe-ctf.com/logout" method="POST">
          <input type="hidden" name="_csrf" value="41GerHLVWlx70F+nKagX+qdPlWQoFXT280RJzgHuj1k=">
          <button type="submit">Sign out</button>
        </form>
      </li>
    </ul>

  <div id="main">
  <div id="title" class="level">
  <h1>Level 8</h1>
  <script type="text/javascript">
  $(function() {
    $("td.done").click(function() {
      window.location = "/levels/" + $(this).attr("level");
      return false;
      });
    });
</script>

<div id="progress">
  <table>
    <tbody><tr>
        <td level="0" class="done"><div><a href="https://stripe-ctf.com/levels/0"><em></em> <span>0</span></a></div></td>
        <td level="1" class="done"><div><a href="https://stripe-ctf.com/levels/1"><em></em> <span>1</span></a></div></td>
        <td level="2" class="done"><div><a href="https://stripe-ctf.com/levels/2"><em></em> <span>2</span></a></div></td>
        <td level="3" class="done"><div><a href="https://stripe-ctf.com/levels/3"><em></em> <span>3</span></a></div></td>
        <td level="4" class="done"><div><a href="https://stripe-ctf.com/levels/4"><em></em> <span>4</span></a></div></td>
        <td level="5" class="done"><div><a href="https://stripe-ctf.com/levels/5"><em></em> <span>5</span></a></div></td>
        <td level="6" class="done"><div><a href="https://stripe-ctf.com/levels/6"><em></em> <span>6</span></a></div></td>
        <td level="7" class="done"><div><a href="https://stripe-ctf.com/levels/7"><em></em> <span>7</span></a></div></td>
        <td level="8" class="done"><div><a href="./StripeCTFWeb2012-Leaderboard_files/StripeCTFWeb2012-Leaderboard.html"><em></em> <span>8</span></a></div></td>
    </tr>
  </tbody></table>
</div>

</div>

<div id="content">
    <p> You completed this level in 152178.66 seconds. The
    password was <code>129934229425</code>.</p>

      <p>The solution you submitted was: <br><code>1. solve local instance as suggested
2. note difference in port offsets for correct/wrong chunks as key to solution
3. note flag is a 12-digit integer split up into 4 chunks, where each chunk is an integer between 000-999 inclusive
4. use level02 to upload 'authorized_keys' for gaining SSH access
5. once in, cat /etc/hosts to find level08-4 machine
6. use level02 web interface to upload Python script to bruteforce each chunk,
   according to observations 2&amp;3, including additional attempts to overcome jitter
7. profit!

thanks for organising this CTF once again! it was certainly a good run overall :)</code></p>

    <hr>


  <p> Welcome to the final level, Level 8. </p>

  <p> HINT 1: No, really, we're not looking for a timing attack. </p>

  <p> HINT 2: Running the server locally is probably a good place to
  start. Anything interesting in the output? </p>

  <p> UPDATE: If you push the reset button, you will be bounced to a
  new <code>level08</code> machine. Note that this will change the
  value of your Flag. If you push reset on Level 2, you will similarly
  be bounced to a new Level 2 machine. </p>

  <p> Because password theft has become such a rampant problem, a
  security firm has decided to create PasswordDB, a new and secure way
  of storing and validating passwords. You've recently learned that the
  Flag itself is protected in a PasswordDB instance, accesible at
  <b><a target="_blank" href="https://level08-4.stripe-ctf.com/user-lxulnzkywg/">https://level08-4.stripe-ctf.com/user-lxulnzkywg/</a></b>. </p>

  <p> PasswordDB exposes a simple JSON API. You just <code>POST</code> a
  payload of the form <code>{"password": "password-to-check",
  "webhooks": ["mysite.com:3000", ...]}</code> to PasswordDB, which will
  respond with a <code>{"success": true}"</code> or <code>{"success":
  false}"</code> to you and your specified webhook endpoints. </p>

  <p> (For example, try running <code>curl https://level08-4.stripe-ctf.com/user-lxulnzkywg/ -d '{"password":
  "password-to-check", "webhooks": []}'</code>.) </p>

  <p> In PasswordDB, the password is never stored in a single location
  or process, making it the bane of attackers' respective
  existences. Instead, the password is "chunked" across multiple
  processes, called "chunk servers". These may live on the same
  machine as the HTTP-accepting "primary server", or for added
  security may live on a different machine. PasswordDB comes with
  built-in security features such as timing attack prevention and
  protection against using unequitable amounts of CPU time (relative
  to other PasswordDB instances on the same machine). </p>

  <p> As a secure cherry on top, the machine hosting the primary
  server has very locked down network access. It can only make
  outbound requests to other <code>stripe-ctf.com</code> servers. As
  you learned in Level 5, someone forgot to internally firewall off
  the high ports from the Level 2 server. (It's almost like someone on
  the inside is helping you â€” there's an <a href="http://linux.about.com/od/commands/l/blcmdl8_sshd.htm">sshd</a>
  running on the Level 2 server as well.) </p>

  <p> To maximize adoption, usability is also a goal of
  PasswordDB. Hence a launcher
  script, <code>password_db_launcher</code>, has been created for the
  express purpose of securing the Flag. It validates that your password
  looks like a valid Flag and automatically spins up 4 chunk servers and
  a primary server. </p>

  <p> You can obtain the code for PasswordDB from <code>git clone https://level08-4.stripe-ctf.com/user-lxulnzkywg/level08-code</code>, or simply read the source below. </p>

  <p> The contents of <code>password_db_launcher</code>:</p>

  <code>
  <table class="CodeRay"><tbody><tr>
  <td class="line-numbers" title="double click to toggle" ondblclick="with (this.firstChild.style) { display = (display == &#39;&#39;) ? &#39;none&#39; : &#39;&#39; }"><pre><a href="https://stripe-ctf.com/levels/8#n1" name="n1">1</a>
<a href="https://stripe-ctf.com/levels/8#n2" name="n2">2</a>
<a href="https://stripe-ctf.com/levels/8#n3" name="n3">3</a>
<a href="https://stripe-ctf.com/levels/8#n4" name="n4">4</a>
<a href="https://stripe-ctf.com/levels/8#n5" name="n5">5</a>
<a href="https://stripe-ctf.com/levels/8#n6" name="n6">6</a>
<a href="https://stripe-ctf.com/levels/8#n7" name="n7">7</a>
<a href="https://stripe-ctf.com/levels/8#n8" name="n8">8</a>
<a href="https://stripe-ctf.com/levels/8#n9" name="n9">9</a>
<strong><a href="https://stripe-ctf.com/levels/8#n10" name="n10">10</a></strong>
<a href="https://stripe-ctf.com/levels/8#n11" name="n11">11</a>
<a href="https://stripe-ctf.com/levels/8#n12" name="n12">12</a>
<a href="https://stripe-ctf.com/levels/8#n13" name="n13">13</a>
<a href="https://stripe-ctf.com/levels/8#n14" name="n14">14</a>
<a href="https://stripe-ctf.com/levels/8#n15" name="n15">15</a>
<a href="https://stripe-ctf.com/levels/8#n16" name="n16">16</a>
<a href="https://stripe-ctf.com/levels/8#n17" name="n17">17</a>
<a href="https://stripe-ctf.com/levels/8#n18" name="n18">18</a>
<a href="https://stripe-ctf.com/levels/8#n19" name="n19">19</a>
<strong><a href="https://stripe-ctf.com/levels/8#n20" name="n20">20</a></strong>
<a href="https://stripe-ctf.com/levels/8#n21" name="n21">21</a>
<a href="https://stripe-ctf.com/levels/8#n22" name="n22">22</a>
<a href="https://stripe-ctf.com/levels/8#n23" name="n23">23</a>
<a href="https://stripe-ctf.com/levels/8#n24" name="n24">24</a>
<a href="https://stripe-ctf.com/levels/8#n25" name="n25">25</a>
<a href="https://stripe-ctf.com/levels/8#n26" name="n26">26</a>
<a href="https://stripe-ctf.com/levels/8#n27" name="n27">27</a>
<a href="https://stripe-ctf.com/levels/8#n28" name="n28">28</a>
<a href="https://stripe-ctf.com/levels/8#n29" name="n29">29</a>
<strong><a href="https://stripe-ctf.com/levels/8#n30" name="n30">30</a></strong>
<a href="https://stripe-ctf.com/levels/8#n31" name="n31">31</a>
<a href="https://stripe-ctf.com/levels/8#n32" name="n32">32</a>
<a href="https://stripe-ctf.com/levels/8#n33" name="n33">33</a>
<a href="https://stripe-ctf.com/levels/8#n34" name="n34">34</a>
<a href="https://stripe-ctf.com/levels/8#n35" name="n35">35</a>
<a href="https://stripe-ctf.com/levels/8#n36" name="n36">36</a>
<a href="https://stripe-ctf.com/levels/8#n37" name="n37">37</a>
<a href="https://stripe-ctf.com/levels/8#n38" name="n38">38</a>
<a href="https://stripe-ctf.com/levels/8#n39" name="n39">39</a>
<strong><a href="https://stripe-ctf.com/levels/8#n40" name="n40">40</a></strong>
<a href="https://stripe-ctf.com/levels/8#n41" name="n41">41</a>
<a href="https://stripe-ctf.com/levels/8#n42" name="n42">42</a>
<a href="https://stripe-ctf.com/levels/8#n43" name="n43">43</a>
<a href="https://stripe-ctf.com/levels/8#n44" name="n44">44</a>
<a href="https://stripe-ctf.com/levels/8#n45" name="n45">45</a>
<a href="https://stripe-ctf.com/levels/8#n46" name="n46">46</a>
<a href="https://stripe-ctf.com/levels/8#n47" name="n47">47</a>
<a href="https://stripe-ctf.com/levels/8#n48" name="n48">48</a>
<a href="https://stripe-ctf.com/levels/8#n49" name="n49">49</a>
<strong><a href="https://stripe-ctf.com/levels/8#n50" name="n50">50</a></strong>
<a href="https://stripe-ctf.com/levels/8#n51" name="n51">51</a>
<a href="https://stripe-ctf.com/levels/8#n52" name="n52">52</a>
<a href="https://stripe-ctf.com/levels/8#n53" name="n53">53</a>
<a href="https://stripe-ctf.com/levels/8#n54" name="n54">54</a>
<a href="https://stripe-ctf.com/levels/8#n55" name="n55">55</a>
<a href="https://stripe-ctf.com/levels/8#n56" name="n56">56</a>
<a href="https://stripe-ctf.com/levels/8#n57" name="n57">57</a>
<a href="https://stripe-ctf.com/levels/8#n58" name="n58">58</a>
<a href="https://stripe-ctf.com/levels/8#n59" name="n59">59</a>
<strong><a href="https://stripe-ctf.com/levels/8#n60" name="n60">60</a></strong>
<a href="https://stripe-ctf.com/levels/8#n61" name="n61">61</a>
<a href="https://stripe-ctf.com/levels/8#n62" name="n62">62</a>
<a href="https://stripe-ctf.com/levels/8#n63" name="n63">63</a>
<a href="https://stripe-ctf.com/levels/8#n64" name="n64">64</a>
<a href="https://stripe-ctf.com/levels/8#n65" name="n65">65</a>
<a href="https://stripe-ctf.com/levels/8#n66" name="n66">66</a>
<a href="https://stripe-ctf.com/levels/8#n67" name="n67">67</a>
<a href="https://stripe-ctf.com/levels/8#n68" name="n68">68</a>
<a href="https://stripe-ctf.com/levels/8#n69" name="n69">69</a>
<strong><a href="https://stripe-ctf.com/levels/8#n70" name="n70">70</a></strong>
<a href="https://stripe-ctf.com/levels/8#n71" name="n71">71</a>
<a href="https://stripe-ctf.com/levels/8#n72" name="n72">72</a>
<a href="https://stripe-ctf.com/levels/8#n73" name="n73">73</a>
<a href="https://stripe-ctf.com/levels/8#n74" name="n74">74</a>
<a href="https://stripe-ctf.com/levels/8#n75" name="n75">75</a>
<a href="https://stripe-ctf.com/levels/8#n76" name="n76">76</a>
<a href="https://stripe-ctf.com/levels/8#n77" name="n77">77</a>
<a href="https://stripe-ctf.com/levels/8#n78" name="n78">78</a>
<a href="https://stripe-ctf.com/levels/8#n79" name="n79">79</a>
<strong><a href="https://stripe-ctf.com/levels/8#n80" name="n80">80</a></strong>
<a href="https://stripe-ctf.com/levels/8#n81" name="n81">81</a>
<a href="https://stripe-ctf.com/levels/8#n82" name="n82">82</a>
<a href="https://stripe-ctf.com/levels/8#n83" name="n83">83</a>
<a href="https://stripe-ctf.com/levels/8#n84" name="n84">84</a>
<a href="https://stripe-ctf.com/levels/8#n85" name="n85">85</a>
<a href="https://stripe-ctf.com/levels/8#n86" name="n86">86</a>
<a href="https://stripe-ctf.com/levels/8#n87" name="n87">87</a>
<a href="https://stripe-ctf.com/levels/8#n88" name="n88">88</a>
<a href="https://stripe-ctf.com/levels/8#n89" name="n89">89</a>
<strong><a href="https://stripe-ctf.com/levels/8#n90" name="n90">90</a></strong>
<a href="https://stripe-ctf.com/levels/8#n91" name="n91">91</a>
<a href="https://stripe-ctf.com/levels/8#n92" name="n92">92</a>
<a href="https://stripe-ctf.com/levels/8#n93" name="n93">93</a>
<a href="https://stripe-ctf.com/levels/8#n94" name="n94">94</a>
<a href="https://stripe-ctf.com/levels/8#n95" name="n95">95</a>
<a href="https://stripe-ctf.com/levels/8#n96" name="n96">96</a>
<a href="https://stripe-ctf.com/levels/8#n97" name="n97">97</a>
<a href="https://stripe-ctf.com/levels/8#n98" name="n98">98</a>
<a href="https://stripe-ctf.com/levels/8#n99" name="n99">99</a>
<strong><a href="https://stripe-ctf.com/levels/8#n100" name="n100">100</a></strong>
<a href="https://stripe-ctf.com/levels/8#n101" name="n101">101</a>
<a href="https://stripe-ctf.com/levels/8#n102" name="n102">102</a>
<a href="https://stripe-ctf.com/levels/8#n103" name="n103">103</a>
<a href="https://stripe-ctf.com/levels/8#n104" name="n104">104</a>
<a href="https://stripe-ctf.com/levels/8#n105" name="n105">105</a>
<a href="https://stripe-ctf.com/levels/8#n106" name="n106">106</a>
<a href="https://stripe-ctf.com/levels/8#n107" name="n107">107</a>
<a href="https://stripe-ctf.com/levels/8#n108" name="n108">108</a>
<a href="https://stripe-ctf.com/levels/8#n109" name="n109">109</a>
<strong><a href="https://stripe-ctf.com/levels/8#n110" name="n110">110</a></strong>
<a href="https://stripe-ctf.com/levels/8#n111" name="n111">111</a>
<a href="https://stripe-ctf.com/levels/8#n112" name="n112">112</a>
<a href="https://stripe-ctf.com/levels/8#n113" name="n113">113</a>
<a href="https://stripe-ctf.com/levels/8#n114" name="n114">114</a>
<a href="https://stripe-ctf.com/levels/8#n115" name="n115">115</a>
<a href="https://stripe-ctf.com/levels/8#n116" name="n116">116</a>
<a href="https://stripe-ctf.com/levels/8#n117" name="n117">117</a>
<a href="https://stripe-ctf.com/levels/8#n118" name="n118">118</a>
<a href="https://stripe-ctf.com/levels/8#n119" name="n119">119</a>
<strong><a href="https://stripe-ctf.com/levels/8#n120" name="n120">120</a></strong>
<a href="https://stripe-ctf.com/levels/8#n121" name="n121">121</a>
<a href="https://stripe-ctf.com/levels/8#n122" name="n122">122</a>
<a href="https://stripe-ctf.com/levels/8#n123" name="n123">123</a>
<a href="https://stripe-ctf.com/levels/8#n124" name="n124">124</a>
<a href="https://stripe-ctf.com/levels/8#n125" name="n125">125</a>
<a href="https://stripe-ctf.com/levels/8#n126" name="n126">126</a>
<a href="https://stripe-ctf.com/levels/8#n127" name="n127">127</a>
<a href="https://stripe-ctf.com/levels/8#n128" name="n128">128</a>
<a href="https://stripe-ctf.com/levels/8#n129" name="n129">129</a>
<strong><a href="https://stripe-ctf.com/levels/8#n130" name="n130">130</a></strong>
<a href="https://stripe-ctf.com/levels/8#n131" name="n131">131</a>
<a href="https://stripe-ctf.com/levels/8#n132" name="n132">132</a>
<a href="https://stripe-ctf.com/levels/8#n133" name="n133">133</a>
<a href="https://stripe-ctf.com/levels/8#n134" name="n134">134</a>
<a href="https://stripe-ctf.com/levels/8#n135" name="n135">135</a>
<a href="https://stripe-ctf.com/levels/8#n136" name="n136">136</a>
<a href="https://stripe-ctf.com/levels/8#n137" name="n137">137</a>
<a href="https://stripe-ctf.com/levels/8#n138" name="n138">138</a>
<a href="https://stripe-ctf.com/levels/8#n139" name="n139">139</a>
<strong><a href="https://stripe-ctf.com/levels/8#n140" name="n140">140</a></strong>
<a href="https://stripe-ctf.com/levels/8#n141" name="n141">141</a>
<a href="https://stripe-ctf.com/levels/8#n142" name="n142">142</a>
<a href="https://stripe-ctf.com/levels/8#n143" name="n143">143</a>
<a href="https://stripe-ctf.com/levels/8#n144" name="n144">144</a>
<a href="https://stripe-ctf.com/levels/8#n145" name="n145">145</a>
<a href="https://stripe-ctf.com/levels/8#n146" name="n146">146</a>
<a href="https://stripe-ctf.com/levels/8#n147" name="n147">147</a>
</pre></td>
  <td class="code"><pre><span style="color:#777">#!/usr/bin/env python</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">atexit</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">logging</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">optparse</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">os</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">os.path</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">random</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">re</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">signal</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">socket</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">subprocess</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">sys</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">time</span>

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">common</span>

logger = logging.getLogger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_db</span><span style="color:#710">'</span></span>)
logger.addHandler(logging.StreamHandler(sys.stderr))

processes = []

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">launch</span>(script, *args):
    path = os.path.join(os.path.dirname(__file__), script)
    args = [path] + <span style="color:#369;font-weight:bold">list</span>(args)
    launched = subprocess.Popen(args)
    logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Launched %r (pid %d)</span><span style="color:#710">'</span></span> % (args, launched.pid))
    processes.append(launched)
    <span style="color:#080;font-weight:bold">return</span> launched

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">nukeChildren</span>():
    logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Killing all remaining children</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">for</span> process <span style="color:#080;font-weight:bold">in</span> processes:
        <span style="color:#080;font-weight:bold">try</span>:
            os.kill(process.pid, signal.SIGTERM)
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#C00;font-weight:bold">OSError</span>:
            <span style="color:#080;font-weight:bold">pass</span>
        <span style="color:#080;font-weight:bold">else</span>:
            logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Killed child %s</span><span style="color:#710">'</span></span> % process.pid)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">waitChildren</span>():
    os.wait()

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">passwordSpecToPassword</span>(password_spec):
    <span style="color:#080;font-weight:bold">if</span> password_spec <span style="color:#080;font-weight:bold">and</span> password_spec[<span style="color:#00D">0</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">@</span><span style="color:#710">'</span></span>:
        password_file = password_spec[<span style="color:#00D">1</span>:]
        logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Reading password from %s</span><span style="color:#710">'</span></span> % password_file)
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#369;font-weight:bold">open</span>(password_file).read()
    <span style="color:#080;font-weight:bold">else</span>:
        <span style="color:#080;font-weight:bold">return</span> password_spec

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">validatePassword</span>(password):
    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> re.search(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">^</span><span style="color:#D20">\d</span><span style="color:#D20">{12}$</span><span style="color:#710">'</span></span>, password):
        <span style="color:#080;font-weight:bold">raise</span> <span style="color:#C00;font-weight:bold">ValueError</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Invalid password! The Flag is a 12-digit number.</span><span style="color:#710">"</span></span>)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">socket_exists</span>(host, port):
    logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Checking whether %s:%s is reachable</span><span style="color:#710">'</span></span> % (host, port))
    <span style="color:#080;font-weight:bold">try</span>:
        socket.create_connection([host, port])
    <span style="color:#080;font-weight:bold">except</span> socket.error:
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">False</span>
    <span style="color:#080;font-weight:bold">else</span>:
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">True</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">find_open_port</span>(base_port):
    <span style="color:#080;font-weight:bold">while</span> socket_exists(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">127.0.0.1</span><span style="color:#710">'</span></span>, base_port):
        base_port += <span style="color:#00D">1</span>
    <span style="color:#080;font-weight:bold">return</span> base_port

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">wait_until</span>(condition, *args):
    <span style="color:#080;font-weight:bold">for</span> i <span style="color:#080;font-weight:bold">in</span> <span style="color:#369;font-weight:bold">xrange</span>(<span style="color:#00D">10</span>):
        <span style="color:#080;font-weight:bold">if</span> condition(*args):
            <span style="color:#080;font-weight:bold">return</span>
        <span style="color:#080;font-weight:bold">else</span>:
            logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Condition not yet true, waiting 0.35 seconds</span><span style="color:#710">'</span></span>
                        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> (try %s/%s)</span><span style="color:#710">'</span></span> % (i+<span style="color:#00D">1</span>, <span style="color:#00D">10</span>))
            time.sleep(<span style="color:#60E">0.35</span>)
    <span style="color:#080;font-weight:bold">raise</span> <span style="color:#C00;font-weight:bold">RuntimeError</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Timed out waiting for condition</span><span style="color:#710">'</span></span>)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">main</span>():
    <span style="color:#777"><span style="color:#444">"""</span><span>
</span><span>    Spins up a secure configuration of PasswordDB:</span><span>
</span><span>
</span><span>    - Uses 4 chunk servers</span><span>
</span><span>    - Validates that the Flag itself looks correct</span><span>
</span><span>    </span><span style="color:#444">"""</span></span>

    usage = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"""</span><span style="color:#D20">%prog [-q ...] &lt;password_spec&gt; &lt;primary_address&gt;</span><span style="color:#D20">
</span><span style="color:#D20">
</span><span style="color:#D20">primary_address should be of the form 'host:port' or 'unix:/path/to/socket'</span><span style="color:#710">"""</span></span>
    parser = optparse.OptionParser(usage)
    parser.add_option(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-q</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">--quiet</span><span style="color:#710">'</span></span>, help=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Quietness of debugging output.</span><span style="color:#710">'</span></span>,
                      dest=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">quiet</span><span style="color:#710">'</span></span>, action=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">count</span><span style="color:#710">'</span></span>, default=<span style="color:#00D">0</span>)
    opts, args = parser.parse_args()
    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> opts.quiet:
        logger.setLevel(logging.DEBUG)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet == <span style="color:#00D">1</span>:
        logger.setLevel(logging.INFO)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet &gt;= <span style="color:#00D">2</span>:
        logger.setLevel(logging.WARN)

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#369;font-weight:bold">len</span>(args) != <span style="color:#00D">2</span>:
        parser.print_usage()
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>

    password_spec = args[<span style="color:#00D">0</span>]
    primary_host_spec = args[<span style="color:#00D">1</span>]

    atexit.register(nukeChildren)

    password = passwordSpecToPassword(password_spec)
    validatePassword(password)

    chunk_count = <span style="color:#00D">4</span>
    chunks = common.chunkPassword(chunk_count, password)

    base_port = random.randint(<span style="color:#00D">1024</span>, <span style="color:#00D">20000</span>)
    chunk_hosts = []
    <span style="color:#080;font-weight:bold">for</span> i <span style="color:#080;font-weight:bold">in</span> <span style="color:#369;font-weight:bold">xrange</span>(chunk_count):
        port = find_open_port(base_port)
        base_port = port + <span style="color:#00D">1</span>
        chunk_hosts.append([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">127.0.0.1</span><span style="color:#710">'</span></span>, port])

    <span style="color:#080;font-weight:bold">for</span> host_port, password_chunk <span style="color:#080;font-weight:bold">in</span> <span style="color:#369;font-weight:bold">zip</span>(chunk_hosts, chunks):
        host, port = host_port
        launch(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">chunk_server</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%s:%s</span><span style="color:#710">'</span></span> % (host, port), password_chunk)

    time.sleep(<span style="color:#60E">0.35</span>)

    <span style="color:#777"># Make sure everything is booted before starting the primary server</span>
    <span style="color:#080;font-weight:bold">for</span> host_port <span style="color:#080;font-weight:bold">in</span> chunk_hosts:
        host, port = host_port
        wait_until(socket_exists, host, port)

    args = []
    args.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-l</span><span style="color:#710">'</span></span>)
    args.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/tmp/primary.lock</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">for</span> host, port <span style="color:#080;font-weight:bold">in</span> chunk_hosts:
        args.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-c</span><span style="color:#710">'</span></span>)
        args.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%s:%s</span><span style="color:#710">'</span></span> % (host, port))
    args.append(primary_host_spec)
    launch(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">primary_server</span><span style="color:#710">'</span></span>, *args)

    waitChildren()
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>

<span style="color:#080;font-weight:bold">if</span> __name__ == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">__main__</span><span style="color:#710">'</span></span>:
    sys.exit(main())
</pre></td>
</tr></tbody></table>

  </code>

  <p> The contents of <code>primary_server</code>:</p>

  <code>
  <table class="CodeRay"><tbody><tr>
  <td class="line-numbers" title="double click to toggle" ondblclick="with (this.firstChild.style) { display = (display == &#39;&#39;) ? &#39;none&#39; : &#39;&#39; }"><pre><a href="https://stripe-ctf.com/levels/8#n1" name="n1">1</a>
<a href="https://stripe-ctf.com/levels/8#n2" name="n2">2</a>
<a href="https://stripe-ctf.com/levels/8#n3" name="n3">3</a>
<a href="https://stripe-ctf.com/levels/8#n4" name="n4">4</a>
<a href="https://stripe-ctf.com/levels/8#n5" name="n5">5</a>
<a href="https://stripe-ctf.com/levels/8#n6" name="n6">6</a>
<a href="https://stripe-ctf.com/levels/8#n7" name="n7">7</a>
<a href="https://stripe-ctf.com/levels/8#n8" name="n8">8</a>
<a href="https://stripe-ctf.com/levels/8#n9" name="n9">9</a>
<strong><a href="https://stripe-ctf.com/levels/8#n10" name="n10">10</a></strong>
<a href="https://stripe-ctf.com/levels/8#n11" name="n11">11</a>
<a href="https://stripe-ctf.com/levels/8#n12" name="n12">12</a>
<a href="https://stripe-ctf.com/levels/8#n13" name="n13">13</a>
<a href="https://stripe-ctf.com/levels/8#n14" name="n14">14</a>
<a href="https://stripe-ctf.com/levels/8#n15" name="n15">15</a>
<a href="https://stripe-ctf.com/levels/8#n16" name="n16">16</a>
<a href="https://stripe-ctf.com/levels/8#n17" name="n17">17</a>
<a href="https://stripe-ctf.com/levels/8#n18" name="n18">18</a>
<a href="https://stripe-ctf.com/levels/8#n19" name="n19">19</a>
<strong><a href="https://stripe-ctf.com/levels/8#n20" name="n20">20</a></strong>
<a href="https://stripe-ctf.com/levels/8#n21" name="n21">21</a>
<a href="https://stripe-ctf.com/levels/8#n22" name="n22">22</a>
<a href="https://stripe-ctf.com/levels/8#n23" name="n23">23</a>
<a href="https://stripe-ctf.com/levels/8#n24" name="n24">24</a>
<a href="https://stripe-ctf.com/levels/8#n25" name="n25">25</a>
<a href="https://stripe-ctf.com/levels/8#n26" name="n26">26</a>
<a href="https://stripe-ctf.com/levels/8#n27" name="n27">27</a>
<a href="https://stripe-ctf.com/levels/8#n28" name="n28">28</a>
<a href="https://stripe-ctf.com/levels/8#n29" name="n29">29</a>
<strong><a href="https://stripe-ctf.com/levels/8#n30" name="n30">30</a></strong>
<a href="https://stripe-ctf.com/levels/8#n31" name="n31">31</a>
<a href="https://stripe-ctf.com/levels/8#n32" name="n32">32</a>
<a href="https://stripe-ctf.com/levels/8#n33" name="n33">33</a>
<a href="https://stripe-ctf.com/levels/8#n34" name="n34">34</a>
<a href="https://stripe-ctf.com/levels/8#n35" name="n35">35</a>
<a href="https://stripe-ctf.com/levels/8#n36" name="n36">36</a>
<a href="https://stripe-ctf.com/levels/8#n37" name="n37">37</a>
<a href="https://stripe-ctf.com/levels/8#n38" name="n38">38</a>
<a href="https://stripe-ctf.com/levels/8#n39" name="n39">39</a>
<strong><a href="https://stripe-ctf.com/levels/8#n40" name="n40">40</a></strong>
<a href="https://stripe-ctf.com/levels/8#n41" name="n41">41</a>
<a href="https://stripe-ctf.com/levels/8#n42" name="n42">42</a>
<a href="https://stripe-ctf.com/levels/8#n43" name="n43">43</a>
<a href="https://stripe-ctf.com/levels/8#n44" name="n44">44</a>
<a href="https://stripe-ctf.com/levels/8#n45" name="n45">45</a>
<a href="https://stripe-ctf.com/levels/8#n46" name="n46">46</a>
<a href="https://stripe-ctf.com/levels/8#n47" name="n47">47</a>
<a href="https://stripe-ctf.com/levels/8#n48" name="n48">48</a>
<a href="https://stripe-ctf.com/levels/8#n49" name="n49">49</a>
<strong><a href="https://stripe-ctf.com/levels/8#n50" name="n50">50</a></strong>
<a href="https://stripe-ctf.com/levels/8#n51" name="n51">51</a>
<a href="https://stripe-ctf.com/levels/8#n52" name="n52">52</a>
<a href="https://stripe-ctf.com/levels/8#n53" name="n53">53</a>
<a href="https://stripe-ctf.com/levels/8#n54" name="n54">54</a>
<a href="https://stripe-ctf.com/levels/8#n55" name="n55">55</a>
<a href="https://stripe-ctf.com/levels/8#n56" name="n56">56</a>
<a href="https://stripe-ctf.com/levels/8#n57" name="n57">57</a>
<a href="https://stripe-ctf.com/levels/8#n58" name="n58">58</a>
<a href="https://stripe-ctf.com/levels/8#n59" name="n59">59</a>
<strong><a href="https://stripe-ctf.com/levels/8#n60" name="n60">60</a></strong>
<a href="https://stripe-ctf.com/levels/8#n61" name="n61">61</a>
<a href="https://stripe-ctf.com/levels/8#n62" name="n62">62</a>
<a href="https://stripe-ctf.com/levels/8#n63" name="n63">63</a>
<a href="https://stripe-ctf.com/levels/8#n64" name="n64">64</a>
<a href="https://stripe-ctf.com/levels/8#n65" name="n65">65</a>
<a href="https://stripe-ctf.com/levels/8#n66" name="n66">66</a>
<a href="https://stripe-ctf.com/levels/8#n67" name="n67">67</a>
<a href="https://stripe-ctf.com/levels/8#n68" name="n68">68</a>
<a href="https://stripe-ctf.com/levels/8#n69" name="n69">69</a>
<strong><a href="https://stripe-ctf.com/levels/8#n70" name="n70">70</a></strong>
<a href="https://stripe-ctf.com/levels/8#n71" name="n71">71</a>
<a href="https://stripe-ctf.com/levels/8#n72" name="n72">72</a>
<a href="https://stripe-ctf.com/levels/8#n73" name="n73">73</a>
<a href="https://stripe-ctf.com/levels/8#n74" name="n74">74</a>
<a href="https://stripe-ctf.com/levels/8#n75" name="n75">75</a>
<a href="https://stripe-ctf.com/levels/8#n76" name="n76">76</a>
<a href="https://stripe-ctf.com/levels/8#n77" name="n77">77</a>
<a href="https://stripe-ctf.com/levels/8#n78" name="n78">78</a>
<a href="https://stripe-ctf.com/levels/8#n79" name="n79">79</a>
<strong><a href="https://stripe-ctf.com/levels/8#n80" name="n80">80</a></strong>
<a href="https://stripe-ctf.com/levels/8#n81" name="n81">81</a>
<a href="https://stripe-ctf.com/levels/8#n82" name="n82">82</a>
<a href="https://stripe-ctf.com/levels/8#n83" name="n83">83</a>
<a href="https://stripe-ctf.com/levels/8#n84" name="n84">84</a>
<a href="https://stripe-ctf.com/levels/8#n85" name="n85">85</a>
<a href="https://stripe-ctf.com/levels/8#n86" name="n86">86</a>
<a href="https://stripe-ctf.com/levels/8#n87" name="n87">87</a>
<a href="https://stripe-ctf.com/levels/8#n88" name="n88">88</a>
<a href="https://stripe-ctf.com/levels/8#n89" name="n89">89</a>
<strong><a href="https://stripe-ctf.com/levels/8#n90" name="n90">90</a></strong>
<a href="https://stripe-ctf.com/levels/8#n91" name="n91">91</a>
<a href="https://stripe-ctf.com/levels/8#n92" name="n92">92</a>
<a href="https://stripe-ctf.com/levels/8#n93" name="n93">93</a>
<a href="https://stripe-ctf.com/levels/8#n94" name="n94">94</a>
<a href="https://stripe-ctf.com/levels/8#n95" name="n95">95</a>
<a href="https://stripe-ctf.com/levels/8#n96" name="n96">96</a>
<a href="https://stripe-ctf.com/levels/8#n97" name="n97">97</a>
<a href="https://stripe-ctf.com/levels/8#n98" name="n98">98</a>
<a href="https://stripe-ctf.com/levels/8#n99" name="n99">99</a>
<strong><a href="https://stripe-ctf.com/levels/8#n100" name="n100">100</a></strong>
<a href="https://stripe-ctf.com/levels/8#n101" name="n101">101</a>
<a href="https://stripe-ctf.com/levels/8#n102" name="n102">102</a>
<a href="https://stripe-ctf.com/levels/8#n103" name="n103">103</a>
<a href="https://stripe-ctf.com/levels/8#n104" name="n104">104</a>
<a href="https://stripe-ctf.com/levels/8#n105" name="n105">105</a>
<a href="https://stripe-ctf.com/levels/8#n106" name="n106">106</a>
<a href="https://stripe-ctf.com/levels/8#n107" name="n107">107</a>
<a href="https://stripe-ctf.com/levels/8#n108" name="n108">108</a>
<a href="https://stripe-ctf.com/levels/8#n109" name="n109">109</a>
<strong><a href="https://stripe-ctf.com/levels/8#n110" name="n110">110</a></strong>
<a href="https://stripe-ctf.com/levels/8#n111" name="n111">111</a>
<a href="https://stripe-ctf.com/levels/8#n112" name="n112">112</a>
<a href="https://stripe-ctf.com/levels/8#n113" name="n113">113</a>
<a href="https://stripe-ctf.com/levels/8#n114" name="n114">114</a>
<a href="https://stripe-ctf.com/levels/8#n115" name="n115">115</a>
<a href="https://stripe-ctf.com/levels/8#n116" name="n116">116</a>
<a href="https://stripe-ctf.com/levels/8#n117" name="n117">117</a>
<a href="https://stripe-ctf.com/levels/8#n118" name="n118">118</a>
<a href="https://stripe-ctf.com/levels/8#n119" name="n119">119</a>
<strong><a href="https://stripe-ctf.com/levels/8#n120" name="n120">120</a></strong>
<a href="https://stripe-ctf.com/levels/8#n121" name="n121">121</a>
<a href="https://stripe-ctf.com/levels/8#n122" name="n122">122</a>
<a href="https://stripe-ctf.com/levels/8#n123" name="n123">123</a>
<a href="https://stripe-ctf.com/levels/8#n124" name="n124">124</a>
<a href="https://stripe-ctf.com/levels/8#n125" name="n125">125</a>
<a href="https://stripe-ctf.com/levels/8#n126" name="n126">126</a>
<a href="https://stripe-ctf.com/levels/8#n127" name="n127">127</a>
<a href="https://stripe-ctf.com/levels/8#n128" name="n128">128</a>
<a href="https://stripe-ctf.com/levels/8#n129" name="n129">129</a>
<strong><a href="https://stripe-ctf.com/levels/8#n130" name="n130">130</a></strong>
<a href="https://stripe-ctf.com/levels/8#n131" name="n131">131</a>
<a href="https://stripe-ctf.com/levels/8#n132" name="n132">132</a>
<a href="https://stripe-ctf.com/levels/8#n133" name="n133">133</a>
<a href="https://stripe-ctf.com/levels/8#n134" name="n134">134</a>
<a href="https://stripe-ctf.com/levels/8#n135" name="n135">135</a>
<a href="https://stripe-ctf.com/levels/8#n136" name="n136">136</a>
<a href="https://stripe-ctf.com/levels/8#n137" name="n137">137</a>
<a href="https://stripe-ctf.com/levels/8#n138" name="n138">138</a>
<a href="https://stripe-ctf.com/levels/8#n139" name="n139">139</a>
<strong><a href="https://stripe-ctf.com/levels/8#n140" name="n140">140</a></strong>
<a href="https://stripe-ctf.com/levels/8#n141" name="n141">141</a>
<a href="https://stripe-ctf.com/levels/8#n142" name="n142">142</a>
<a href="https://stripe-ctf.com/levels/8#n143" name="n143">143</a>
<a href="https://stripe-ctf.com/levels/8#n144" name="n144">144</a>
<a href="https://stripe-ctf.com/levels/8#n145" name="n145">145</a>
<a href="https://stripe-ctf.com/levels/8#n146" name="n146">146</a>
<a href="https://stripe-ctf.com/levels/8#n147" name="n147">147</a>
<a href="https://stripe-ctf.com/levels/8#n148" name="n148">148</a>
<a href="https://stripe-ctf.com/levels/8#n149" name="n149">149</a>
<strong><a href="https://stripe-ctf.com/levels/8#n150" name="n150">150</a></strong>
<a href="https://stripe-ctf.com/levels/8#n151" name="n151">151</a>
<a href="https://stripe-ctf.com/levels/8#n152" name="n152">152</a>
<a href="https://stripe-ctf.com/levels/8#n153" name="n153">153</a>
<a href="https://stripe-ctf.com/levels/8#n154" name="n154">154</a>
<a href="https://stripe-ctf.com/levels/8#n155" name="n155">155</a>
<a href="https://stripe-ctf.com/levels/8#n156" name="n156">156</a>
<a href="https://stripe-ctf.com/levels/8#n157" name="n157">157</a>
<a href="https://stripe-ctf.com/levels/8#n158" name="n158">158</a>
<a href="https://stripe-ctf.com/levels/8#n159" name="n159">159</a>
<strong><a href="https://stripe-ctf.com/levels/8#n160" name="n160">160</a></strong>
<a href="https://stripe-ctf.com/levels/8#n161" name="n161">161</a>
<a href="https://stripe-ctf.com/levels/8#n162" name="n162">162</a>
<a href="https://stripe-ctf.com/levels/8#n163" name="n163">163</a>
<a href="https://stripe-ctf.com/levels/8#n164" name="n164">164</a>
<a href="https://stripe-ctf.com/levels/8#n165" name="n165">165</a>
<a href="https://stripe-ctf.com/levels/8#n166" name="n166">166</a>
<a href="https://stripe-ctf.com/levels/8#n167" name="n167">167</a>
<a href="https://stripe-ctf.com/levels/8#n168" name="n168">168</a>
<a href="https://stripe-ctf.com/levels/8#n169" name="n169">169</a>
<strong><a href="https://stripe-ctf.com/levels/8#n170" name="n170">170</a></strong>
<a href="https://stripe-ctf.com/levels/8#n171" name="n171">171</a>
<a href="https://stripe-ctf.com/levels/8#n172" name="n172">172</a>
<a href="https://stripe-ctf.com/levels/8#n173" name="n173">173</a>
<a href="https://stripe-ctf.com/levels/8#n174" name="n174">174</a>
<a href="https://stripe-ctf.com/levels/8#n175" name="n175">175</a>
<a href="https://stripe-ctf.com/levels/8#n176" name="n176">176</a>
<a href="https://stripe-ctf.com/levels/8#n177" name="n177">177</a>
<a href="https://stripe-ctf.com/levels/8#n178" name="n178">178</a>
<a href="https://stripe-ctf.com/levels/8#n179" name="n179">179</a>
<strong><a href="https://stripe-ctf.com/levels/8#n180" name="n180">180</a></strong>
<a href="https://stripe-ctf.com/levels/8#n181" name="n181">181</a>
<a href="https://stripe-ctf.com/levels/8#n182" name="n182">182</a>
<a href="https://stripe-ctf.com/levels/8#n183" name="n183">183</a>
<a href="https://stripe-ctf.com/levels/8#n184" name="n184">184</a>
<a href="https://stripe-ctf.com/levels/8#n185" name="n185">185</a>
<a href="https://stripe-ctf.com/levels/8#n186" name="n186">186</a>
<a href="https://stripe-ctf.com/levels/8#n187" name="n187">187</a>
<a href="https://stripe-ctf.com/levels/8#n188" name="n188">188</a>
<a href="https://stripe-ctf.com/levels/8#n189" name="n189">189</a>
<strong><a href="https://stripe-ctf.com/levels/8#n190" name="n190">190</a></strong>
<a href="https://stripe-ctf.com/levels/8#n191" name="n191">191</a>
<a href="https://stripe-ctf.com/levels/8#n192" name="n192">192</a>
<a href="https://stripe-ctf.com/levels/8#n193" name="n193">193</a>
<a href="https://stripe-ctf.com/levels/8#n194" name="n194">194</a>
<a href="https://stripe-ctf.com/levels/8#n195" name="n195">195</a>
<a href="https://stripe-ctf.com/levels/8#n196" name="n196">196</a>
<a href="https://stripe-ctf.com/levels/8#n197" name="n197">197</a>
<a href="https://stripe-ctf.com/levels/8#n198" name="n198">198</a>
<a href="https://stripe-ctf.com/levels/8#n199" name="n199">199</a>
</pre></td>
  <td class="code"><pre><span style="color:#777">#!/usr/bin/env python</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">fcntl</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">logging</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">json</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">optparse</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">sys</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">time</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">traceback</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">twisted.internet</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">reactor</span>

<span style="color:#777"># Local project</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">common</span>

logger = logging.getLogger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_db</span><span style="color:#710">'</span></span>)
logger.addHandler(logging.StreamHandler(sys.stderr))


<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PrimaryProcessor</span>(common.PayloadProcessor):
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">__init__</span>(<span style="color:#069">self</span>, request, chunk_servers):
        <span style="color:#369;font-weight:bold">super</span>(PrimaryProcessor, <span style="color:#069">self</span>).__init__(request)
        <span style="color:#069">self</span>.chunk_servers = chunk_servers

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">process</span>(<span style="color:#069">self</span>, data):
        Shield.registerLocker()

        password = <span style="color:#069">self</span>.getArg(data, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password</span><span style="color:#710">'</span></span>)
        webhooks = <span style="color:#069">self</span>.getArg(data, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">webhooks</span><span style="color:#710">'</span></span>)

        <span style="color:#069">self</span>.start_time = time.time()

        <span style="color:#069">self</span>.remaining_chunk_servers = <span style="color:#069">self</span>.chunk_servers[:]
        <span style="color:#069">self</span>.remaining_chunks = <span style="color:#069">self</span>.chunkPassword(password)

        <span style="color:#069">self</span>.webhooks = [common.parseHost(webhook) <span style="color:#080;font-weight:bold">for</span> webhook <span style="color:#080;font-weight:bold">in</span> webhooks]

        <span style="color:#069">self</span>.checkNext()

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">checkNext</span>(<span style="color:#069">self</span>):
        <span style="color:#080;font-weight:bold">assert</span>(<span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.remaining_chunks) == <span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.remaining_chunk_servers))

        <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> <span style="color:#069">self</span>.remaining_chunk_servers:
            <span style="color:#069">self</span>.sendResult(<span style="color:#069">True</span>)
            <span style="color:#080;font-weight:bold">return</span>

        next_chunk_server = <span style="color:#069">self</span>.remaining_chunk_servers.pop(<span style="color:#00D">0</span>)
        next_chunk = <span style="color:#069">self</span>.remaining_chunks.pop(<span style="color:#00D">0</span>)

        <span style="color:#069">self</span>.log_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Making request to chunk server %r</span><span style="color:#710">'</span></span>
                      <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> (remaining chunk servers: %r)</span><span style="color:#710">'</span></span> %
                      (next_chunk_server, <span style="color:#069">self</span>.remaining_chunk_servers))

        common.makeRequest(next_chunk_server,
                           {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_chunk</span><span style="color:#710">'</span></span> : next_chunk},
                           <span style="color:#069">self</span>.nextServerCallback,
                           <span style="color:#069">self</span>.nextServerErrback)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">nextServerCallback</span>(<span style="color:#069">self</span>, data):
        parsed_data = json.loads(data)
        <span style="color:#777"># Chunk was wrong!</span>
        <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> parsed_data[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">success</span><span style="color:#710">'</span></span>]:
            <span style="color:#777"># Defend against timing attacks</span>
            remaining_time = <span style="color:#069">self</span>.expectedRemainingTime()
            <span style="color:#069">self</span>.log_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Going to wait %s seconds before responding</span><span style="color:#710">'</span></span> %
                          remaining_time)
            reactor.callLater(remaining_time, <span style="color:#069">self</span>.sendResult, <span style="color:#069">False</span>)
            <span style="color:#080;font-weight:bold">return</span>

        <span style="color:#069">self</span>.checkNext()

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">expectedRemainingTime</span>(<span style="color:#069">self</span>):
        <span style="color:#080;font-weight:bold">assert</span>(<span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.chunk_servers) &gt; <span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.remaining_chunk_servers))
        elapsed_time = time.time() - <span style="color:#069">self</span>.start_time
        ratio_remaining_to_elapsed = (<span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.remaining_chunk_servers) * <span style="color:#60E">1.0</span>
            / (<span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.chunk_servers) - <span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.remaining_chunk_servers)))
        <span style="color:#080;font-weight:bold">return</span> ratio_remaining_to_elapsed * elapsed_time

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">nextServerErrback</span>(<span style="color:#069">self</span>, address_spec, error):
        backtrace = traceback.format_exc(error)
        <span style="color:#069">self</span>.log_error(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Error while connecting to chunk server %r: %s (%r)</span><span style="color:#710">'</span></span> %
                       (address_spec, error, backtrace))
        <span style="color:#069">self</span>.respondWithMessage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Error! This should never happen in </span><span style="color:#710">'</span></span>
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">production, but it seems that it did. Contact</span><span style="color:#710">'</span></span>
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> us at ctf@stripe.com to let us know.</span><span style="color:#710">'</span></span>)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sendResult</span>(<span style="color:#069">self</span>, success):
        result = {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">success</span><span style="color:#710">'</span></span>: success}
        <span style="color:#069">self</span>.respond(result)
        <span style="color:#080;font-weight:bold">for</span> webhook <span style="color:#080;font-weight:bold">in</span> <span style="color:#069">self</span>.webhooks:
            <span style="color:#069">self</span>.sendWebhook(webhook, result)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sendWebhook</span>(<span style="color:#069">self</span>, webhook_host_spec, result):
        <span style="color:#069">self</span>.log_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Sending webhook to %r: %s</span><span style="color:#710">'</span></span> %
                      (webhook_host_spec, result))
        common.makeRequest(webhook_host_spec, result, <span style="color:#069">self</span>.sendWebhookCallback,
                           <span style="color:#069">self</span>.sendWebhookErrback)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sendWebhookCallback</span>(<span style="color:#069">self</span>, data):
        <span style="color:#777"># Too late to do anything here</span>
        <span style="color:#080;font-weight:bold">pass</span>

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sendWebhookErrback</span>(<span style="color:#069">self</span>, address_spec, error):
        backtrace = traceback.format_exc(error)
        <span style="color:#069">self</span>.log_error(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Error while connecting to webhook server %r: %s (%r)</span><span style="color:#710">'</span></span> %
                       (address_spec, error, backtrace))

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">chunkPassword</span>(<span style="color:#069">self</span>, password):
        <span style="color:#080;font-weight:bold">return</span> common.chunkPassword(<span style="color:#369;font-weight:bold">len</span>(<span style="color:#069">self</span>.chunk_servers), password, <span style="color:#069">self</span>)

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Shield</span>(<span style="color:#369;font-weight:bold">object</span>):
    <span style="color:#777"># Ensure equitable distribution of load among many PasswordDB</span>
    <span style="color:#777"># instances on a single server. (Typically servers come with many</span>
    <span style="color:#777"># PasswordDB instances.)</span>
    <span style="color:#B0B">@classmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">registerLocker</span>(<span style="color:#069">self</span>):
        <span style="color:#080;font-weight:bold">if</span> <span style="color:#069">self</span>.has_lock:
            <span style="color:#080;font-weight:bold">return</span>

        <span style="color:#069">self</span>.acquireLock()
        reactor.callLater(<span style="color:#069">self</span>.lock_period, <span style="color:#069">self</span>.releaseLock)

    <span style="color:#B0B">@classmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">acquireLock</span>(<span style="color:#069">self</span>):
        logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Acquiring lock</span><span style="color:#710">'</span></span>)
        fcntl.flock(<span style="color:#069">self</span>.lockfile, fcntl.LOCK_EX)
        <span style="color:#069">self</span>.has_lock = <span style="color:#069">True</span>

    <span style="color:#B0B">@classmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">releaseLock</span>(<span style="color:#069">self</span>):
        logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Releasing lock</span><span style="color:#710">'</span></span>)
        fcntl.flock(<span style="color:#069">self</span>.lockfile, fcntl.LOCK_UN)
        <span style="color:#069">self</span>.has_lock = <span style="color:#069">False</span>

    <span style="color:#B0B">@classmethod</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">openLockfile</span>(<span style="color:#069">self</span>, path):
        <span style="color:#069">self</span>.lock_period = <span style="color:#60E">0.250</span>
        <span style="color:#069">self</span>.has_lock = <span style="color:#069">False</span>
        <span style="color:#069">self</span>.lockfile = <span style="color:#369;font-weight:bold">open</span>(path, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">w</span><span style="color:#710">'</span></span>)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">main</span>():
    usage = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"""</span><span style="color:#D20">
</span><span style="color:#D20">%prog -c CHUNK_SERVER [-c CHUNK_SERVER ...] [-q ...] -l /path/to/lockfile PRIMARY_SERVER</span><span style="color:#D20">
</span><span style="color:#D20">
</span><span style="color:#D20">CHUNK_SERVER:</span><span style="color:#D20">
</span><span style="color:#D20">    A chunk server to spin up as &lt;chunk_host:chunk_port&gt;</span><span style="color:#D20">
</span><span style="color:#D20">
</span><span style="color:#D20">PRIMARY_SERVER:</span><span style="color:#D20">
</span><span style="color:#D20">    Either pass a host:port pair &lt;primary_host:primary_port&gt; or pass a</span><span style="color:#D20">
</span><span style="color:#D20">    unix:-prefixed path for it to listen on a UNIX socket</span><span style="color:#D20">
</span><span style="color:#D20">    &lt;unix:/path/to/socket&gt; (useful for running under FastCGI).</span><span style="color:#D20">
</span><span style="color:#710">"""</span></span>
    parser = optparse.OptionParser(usage)
    parser.add_option(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-q</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">--quiet</span><span style="color:#710">'</span></span>, help=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Quietness of debugging output.</span><span style="color:#710">'</span></span>,
                      dest=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">quiet</span><span style="color:#710">'</span></span>, action=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">count</span><span style="color:#710">'</span></span>, default=<span style="color:#00D">0</span>)
    parser.add_option(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-c</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">--chunk-servers</span><span style="color:#710">'</span></span>,
                      help=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Add a chunk server to spin up</span><span style="color:#710">'</span></span>,
                      dest=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">chunk_servers</span><span style="color:#710">'</span></span>, action=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">append</span><span style="color:#710">'</span></span>, default=[])
    parser.add_option(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-l</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">--lock-file</span><span style="color:#710">'</span></span>,
                      help=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Path to lockfile</span><span style="color:#710">'</span></span>,
                      dest=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lockfile</span><span style="color:#710">'</span></span>)
    opts, args = parser.parse_args()
    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> opts.quiet:
        logger.setLevel(logging.DEBUG)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet == <span style="color:#00D">1</span>:
        logger.setLevel(logging.INFO)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet &gt;= <span style="color:#00D">2</span>:
        logger.setLevel(logging.WARN)

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#369;font-weight:bold">len</span>(args) != <span style="color:#00D">1</span>:
        parser.print_usage()
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> opts.chunk_servers:
        parser.print_usage()
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> opts.lockfile:
        parser.print_usage()
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>

    Shield.openLockfile(opts.lockfile)

    chunk_servers = [common.parseHost(spec) <span style="color:#080;font-weight:bold">for</span> spec <span style="color:#080;font-weight:bold">in</span> opts.chunk_servers]

    server = common.HTTPServer(PrimaryProcessor, chunk_servers)

    spec = args[<span style="color:#00D">0</span>]
    <span style="color:#080;font-weight:bold">if</span> common.isUnix(spec):
        path = common.parseUnix(spec)
        common.listenUNIX(path, server)
    <span style="color:#080;font-weight:bold">else</span>:
        address_spec = common.parseHost(args[<span style="color:#00D">0</span>])
        common.listenTCP(address_spec, server)

    reactor.run()
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>

<span style="color:#080;font-weight:bold">if</span> __name__ == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">__main__</span><span style="color:#710">'</span></span>:
    sys.exit(main())
</pre></td>
</tr></tbody></table>

  </code>

  <p> The contents of <code>chunk_server</code>:</p>

  <code>
  <table class="CodeRay"><tbody><tr>
  <td class="line-numbers" title="double click to toggle" ondblclick="with (this.firstChild.style) { display = (display == &#39;&#39;) ? &#39;none&#39; : &#39;&#39; }"><pre><a href="https://stripe-ctf.com/levels/8#n1" name="n1">1</a>
<a href="https://stripe-ctf.com/levels/8#n2" name="n2">2</a>
<a href="https://stripe-ctf.com/levels/8#n3" name="n3">3</a>
<a href="https://stripe-ctf.com/levels/8#n4" name="n4">4</a>
<a href="https://stripe-ctf.com/levels/8#n5" name="n5">5</a>
<a href="https://stripe-ctf.com/levels/8#n6" name="n6">6</a>
<a href="https://stripe-ctf.com/levels/8#n7" name="n7">7</a>
<a href="https://stripe-ctf.com/levels/8#n8" name="n8">8</a>
<a href="https://stripe-ctf.com/levels/8#n9" name="n9">9</a>
<strong><a href="https://stripe-ctf.com/levels/8#n10" name="n10">10</a></strong>
<a href="https://stripe-ctf.com/levels/8#n11" name="n11">11</a>
<a href="https://stripe-ctf.com/levels/8#n12" name="n12">12</a>
<a href="https://stripe-ctf.com/levels/8#n13" name="n13">13</a>
<a href="https://stripe-ctf.com/levels/8#n14" name="n14">14</a>
<a href="https://stripe-ctf.com/levels/8#n15" name="n15">15</a>
<a href="https://stripe-ctf.com/levels/8#n16" name="n16">16</a>
<a href="https://stripe-ctf.com/levels/8#n17" name="n17">17</a>
<a href="https://stripe-ctf.com/levels/8#n18" name="n18">18</a>
<a href="https://stripe-ctf.com/levels/8#n19" name="n19">19</a>
<strong><a href="https://stripe-ctf.com/levels/8#n20" name="n20">20</a></strong>
<a href="https://stripe-ctf.com/levels/8#n21" name="n21">21</a>
<a href="https://stripe-ctf.com/levels/8#n22" name="n22">22</a>
<a href="https://stripe-ctf.com/levels/8#n23" name="n23">23</a>
<a href="https://stripe-ctf.com/levels/8#n24" name="n24">24</a>
<a href="https://stripe-ctf.com/levels/8#n25" name="n25">25</a>
<a href="https://stripe-ctf.com/levels/8#n26" name="n26">26</a>
<a href="https://stripe-ctf.com/levels/8#n27" name="n27">27</a>
<a href="https://stripe-ctf.com/levels/8#n28" name="n28">28</a>
<a href="https://stripe-ctf.com/levels/8#n29" name="n29">29</a>
<strong><a href="https://stripe-ctf.com/levels/8#n30" name="n30">30</a></strong>
<a href="https://stripe-ctf.com/levels/8#n31" name="n31">31</a>
<a href="https://stripe-ctf.com/levels/8#n32" name="n32">32</a>
<a href="https://stripe-ctf.com/levels/8#n33" name="n33">33</a>
<a href="https://stripe-ctf.com/levels/8#n34" name="n34">34</a>
<a href="https://stripe-ctf.com/levels/8#n35" name="n35">35</a>
<a href="https://stripe-ctf.com/levels/8#n36" name="n36">36</a>
<a href="https://stripe-ctf.com/levels/8#n37" name="n37">37</a>
<a href="https://stripe-ctf.com/levels/8#n38" name="n38">38</a>
<a href="https://stripe-ctf.com/levels/8#n39" name="n39">39</a>
<strong><a href="https://stripe-ctf.com/levels/8#n40" name="n40">40</a></strong>
<a href="https://stripe-ctf.com/levels/8#n41" name="n41">41</a>
<a href="https://stripe-ctf.com/levels/8#n42" name="n42">42</a>
<a href="https://stripe-ctf.com/levels/8#n43" name="n43">43</a>
<a href="https://stripe-ctf.com/levels/8#n44" name="n44">44</a>
<a href="https://stripe-ctf.com/levels/8#n45" name="n45">45</a>
<a href="https://stripe-ctf.com/levels/8#n46" name="n46">46</a>
<a href="https://stripe-ctf.com/levels/8#n47" name="n47">47</a>
<a href="https://stripe-ctf.com/levels/8#n48" name="n48">48</a>
<a href="https://stripe-ctf.com/levels/8#n49" name="n49">49</a>
<strong><a href="https://stripe-ctf.com/levels/8#n50" name="n50">50</a></strong>
<a href="https://stripe-ctf.com/levels/8#n51" name="n51">51</a>
<a href="https://stripe-ctf.com/levels/8#n52" name="n52">52</a>
<a href="https://stripe-ctf.com/levels/8#n53" name="n53">53</a>
</pre></td>
  <td class="code"><pre><span style="color:#777">#!/usr/bin/env python</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">logging</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">optparse</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">sys</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">twisted.internet</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">reactor</span>

<span style="color:#777"># Local project</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">common</span>

logger = logging.getLogger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_db</span><span style="color:#710">'</span></span>)
logger.addHandler(logging.StreamHandler(sys.stderr))

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ChunkProcessor</span>(common.PayloadProcessor):
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">__init__</span>(<span style="color:#069">self</span>, request, password_chunk):
        <span style="color:#369;font-weight:bold">super</span>(ChunkProcessor, <span style="color:#069">self</span>).__init__(request)
        <span style="color:#069">self</span>.password_chunk = password_chunk

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">process</span>(<span style="color:#069">self</span>, data):
        chunk = <span style="color:#069">self</span>.getArg(data, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_chunk</span><span style="color:#710">'</span></span>)
        success = chunk == <span style="color:#069">self</span>.password_chunk
        <span style="color:#069">self</span>.respond({
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">success</span><span style="color:#710">'</span></span> : success
                })

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">main</span>():
    usage = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"""</span><span style="color:#D20">%prog [-q ...] &lt;host:port&gt; &lt;password_chunk&gt;</span><span style="color:#710">"""</span></span>
    parser = optparse.OptionParser(usage)
    parser.add_option(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">-q</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">--quiet</span><span style="color:#710">'</span></span>, help=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Quietness of debugging output.</span><span style="color:#710">'</span></span>,
                      dest=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">quiet</span><span style="color:#710">'</span></span>, action=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">count</span><span style="color:#710">'</span></span>, default=<span style="color:#00D">0</span>)
    opts, args = parser.parse_args()
    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> opts.quiet:
        logger.setLevel(logging.DEBUG)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet == <span style="color:#00D">1</span>:
        logger.setLevel(logging.INFO)
    <span style="color:#080;font-weight:bold">elif</span> opts.quiet &gt;= <span style="color:#00D">2</span>:
        logger.setLevel(logging.WARN)

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#369;font-weight:bold">len</span>(args) != <span style="color:#00D">2</span>:
        parser.print_usage()
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>

    address_spec = common.parseHost(args[<span style="color:#00D">0</span>])
    password_chunk = args[<span style="color:#00D">1</span>]

    server = common.HTTPServer(ChunkProcessor, password_chunk)
    common.listenTCP(address_spec, server)
    reactor.run()

    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>

<span style="color:#080;font-weight:bold">if</span> __name__ == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">__main__</span><span style="color:#710">'</span></span>:
    sys.exit(main())
</pre></td>
</tr></tbody></table>

  </code>


  <p> The contents of <code>common.py</code>:</p>

  <code>
  <table class="CodeRay"><tbody><tr>
  <td class="line-numbers" title="double click to toggle" ondblclick="with (this.firstChild.style) { display = (display == &#39;&#39;) ? &#39;none&#39; : &#39;&#39; }"><pre><a href="https://stripe-ctf.com/levels/8#n1" name="n1">1</a>
<a href="https://stripe-ctf.com/levels/8#n2" name="n2">2</a>
<a href="https://stripe-ctf.com/levels/8#n3" name="n3">3</a>
<a href="https://stripe-ctf.com/levels/8#n4" name="n4">4</a>
<a href="https://stripe-ctf.com/levels/8#n5" name="n5">5</a>
<a href="https://stripe-ctf.com/levels/8#n6" name="n6">6</a>
<a href="https://stripe-ctf.com/levels/8#n7" name="n7">7</a>
<a href="https://stripe-ctf.com/levels/8#n8" name="n8">8</a>
<a href="https://stripe-ctf.com/levels/8#n9" name="n9">9</a>
<strong><a href="https://stripe-ctf.com/levels/8#n10" name="n10">10</a></strong>
<a href="https://stripe-ctf.com/levels/8#n11" name="n11">11</a>
<a href="https://stripe-ctf.com/levels/8#n12" name="n12">12</a>
<a href="https://stripe-ctf.com/levels/8#n13" name="n13">13</a>
<a href="https://stripe-ctf.com/levels/8#n14" name="n14">14</a>
<a href="https://stripe-ctf.com/levels/8#n15" name="n15">15</a>
<a href="https://stripe-ctf.com/levels/8#n16" name="n16">16</a>
<a href="https://stripe-ctf.com/levels/8#n17" name="n17">17</a>
<a href="https://stripe-ctf.com/levels/8#n18" name="n18">18</a>
<a href="https://stripe-ctf.com/levels/8#n19" name="n19">19</a>
<strong><a href="https://stripe-ctf.com/levels/8#n20" name="n20">20</a></strong>
<a href="https://stripe-ctf.com/levels/8#n21" name="n21">21</a>
<a href="https://stripe-ctf.com/levels/8#n22" name="n22">22</a>
<a href="https://stripe-ctf.com/levels/8#n23" name="n23">23</a>
<a href="https://stripe-ctf.com/levels/8#n24" name="n24">24</a>
<a href="https://stripe-ctf.com/levels/8#n25" name="n25">25</a>
<a href="https://stripe-ctf.com/levels/8#n26" name="n26">26</a>
<a href="https://stripe-ctf.com/levels/8#n27" name="n27">27</a>
<a href="https://stripe-ctf.com/levels/8#n28" name="n28">28</a>
<a href="https://stripe-ctf.com/levels/8#n29" name="n29">29</a>
<strong><a href="https://stripe-ctf.com/levels/8#n30" name="n30">30</a></strong>
<a href="https://stripe-ctf.com/levels/8#n31" name="n31">31</a>
<a href="https://stripe-ctf.com/levels/8#n32" name="n32">32</a>
<a href="https://stripe-ctf.com/levels/8#n33" name="n33">33</a>
<a href="https://stripe-ctf.com/levels/8#n34" name="n34">34</a>
<a href="https://stripe-ctf.com/levels/8#n35" name="n35">35</a>
<a href="https://stripe-ctf.com/levels/8#n36" name="n36">36</a>
<a href="https://stripe-ctf.com/levels/8#n37" name="n37">37</a>
<a href="https://stripe-ctf.com/levels/8#n38" name="n38">38</a>
<a href="https://stripe-ctf.com/levels/8#n39" name="n39">39</a>
<strong><a href="https://stripe-ctf.com/levels/8#n40" name="n40">40</a></strong>
<a href="https://stripe-ctf.com/levels/8#n41" name="n41">41</a>
<a href="https://stripe-ctf.com/levels/8#n42" name="n42">42</a>
<a href="https://stripe-ctf.com/levels/8#n43" name="n43">43</a>
<a href="https://stripe-ctf.com/levels/8#n44" name="n44">44</a>
<a href="https://stripe-ctf.com/levels/8#n45" name="n45">45</a>
<a href="https://stripe-ctf.com/levels/8#n46" name="n46">46</a>
<a href="https://stripe-ctf.com/levels/8#n47" name="n47">47</a>
<a href="https://stripe-ctf.com/levels/8#n48" name="n48">48</a>
<a href="https://stripe-ctf.com/levels/8#n49" name="n49">49</a>
<strong><a href="https://stripe-ctf.com/levels/8#n50" name="n50">50</a></strong>
<a href="https://stripe-ctf.com/levels/8#n51" name="n51">51</a>
<a href="https://stripe-ctf.com/levels/8#n52" name="n52">52</a>
<a href="https://stripe-ctf.com/levels/8#n53" name="n53">53</a>
<a href="https://stripe-ctf.com/levels/8#n54" name="n54">54</a>
<a href="https://stripe-ctf.com/levels/8#n55" name="n55">55</a>
<a href="https://stripe-ctf.com/levels/8#n56" name="n56">56</a>
<a href="https://stripe-ctf.com/levels/8#n57" name="n57">57</a>
<a href="https://stripe-ctf.com/levels/8#n58" name="n58">58</a>
<a href="https://stripe-ctf.com/levels/8#n59" name="n59">59</a>
<strong><a href="https://stripe-ctf.com/levels/8#n60" name="n60">60</a></strong>
<a href="https://stripe-ctf.com/levels/8#n61" name="n61">61</a>
<a href="https://stripe-ctf.com/levels/8#n62" name="n62">62</a>
<a href="https://stripe-ctf.com/levels/8#n63" name="n63">63</a>
<a href="https://stripe-ctf.com/levels/8#n64" name="n64">64</a>
<a href="https://stripe-ctf.com/levels/8#n65" name="n65">65</a>
<a href="https://stripe-ctf.com/levels/8#n66" name="n66">66</a>
<a href="https://stripe-ctf.com/levels/8#n67" name="n67">67</a>
<a href="https://stripe-ctf.com/levels/8#n68" name="n68">68</a>
<a href="https://stripe-ctf.com/levels/8#n69" name="n69">69</a>
<strong><a href="https://stripe-ctf.com/levels/8#n70" name="n70">70</a></strong>
<a href="https://stripe-ctf.com/levels/8#n71" name="n71">71</a>
<a href="https://stripe-ctf.com/levels/8#n72" name="n72">72</a>
<a href="https://stripe-ctf.com/levels/8#n73" name="n73">73</a>
<a href="https://stripe-ctf.com/levels/8#n74" name="n74">74</a>
<a href="https://stripe-ctf.com/levels/8#n75" name="n75">75</a>
<a href="https://stripe-ctf.com/levels/8#n76" name="n76">76</a>
<a href="https://stripe-ctf.com/levels/8#n77" name="n77">77</a>
<a href="https://stripe-ctf.com/levels/8#n78" name="n78">78</a>
<a href="https://stripe-ctf.com/levels/8#n79" name="n79">79</a>
<strong><a href="https://stripe-ctf.com/levels/8#n80" name="n80">80</a></strong>
<a href="https://stripe-ctf.com/levels/8#n81" name="n81">81</a>
<a href="https://stripe-ctf.com/levels/8#n82" name="n82">82</a>
<a href="https://stripe-ctf.com/levels/8#n83" name="n83">83</a>
<a href="https://stripe-ctf.com/levels/8#n84" name="n84">84</a>
<a href="https://stripe-ctf.com/levels/8#n85" name="n85">85</a>
<a href="https://stripe-ctf.com/levels/8#n86" name="n86">86</a>
<a href="https://stripe-ctf.com/levels/8#n87" name="n87">87</a>
<a href="https://stripe-ctf.com/levels/8#n88" name="n88">88</a>
<a href="https://stripe-ctf.com/levels/8#n89" name="n89">89</a>
<strong><a href="https://stripe-ctf.com/levels/8#n90" name="n90">90</a></strong>
<a href="https://stripe-ctf.com/levels/8#n91" name="n91">91</a>
<a href="https://stripe-ctf.com/levels/8#n92" name="n92">92</a>
<a href="https://stripe-ctf.com/levels/8#n93" name="n93">93</a>
<a href="https://stripe-ctf.com/levels/8#n94" name="n94">94</a>
<a href="https://stripe-ctf.com/levels/8#n95" name="n95">95</a>
<a href="https://stripe-ctf.com/levels/8#n96" name="n96">96</a>
<a href="https://stripe-ctf.com/levels/8#n97" name="n97">97</a>
<a href="https://stripe-ctf.com/levels/8#n98" name="n98">98</a>
<a href="https://stripe-ctf.com/levels/8#n99" name="n99">99</a>
<strong><a href="https://stripe-ctf.com/levels/8#n100" name="n100">100</a></strong>
<a href="https://stripe-ctf.com/levels/8#n101" name="n101">101</a>
<a href="https://stripe-ctf.com/levels/8#n102" name="n102">102</a>
<a href="https://stripe-ctf.com/levels/8#n103" name="n103">103</a>
<a href="https://stripe-ctf.com/levels/8#n104" name="n104">104</a>
<a href="https://stripe-ctf.com/levels/8#n105" name="n105">105</a>
<a href="https://stripe-ctf.com/levels/8#n106" name="n106">106</a>
<a href="https://stripe-ctf.com/levels/8#n107" name="n107">107</a>
<a href="https://stripe-ctf.com/levels/8#n108" name="n108">108</a>
<a href="https://stripe-ctf.com/levels/8#n109" name="n109">109</a>
<strong><a href="https://stripe-ctf.com/levels/8#n110" name="n110">110</a></strong>
<a href="https://stripe-ctf.com/levels/8#n111" name="n111">111</a>
<a href="https://stripe-ctf.com/levels/8#n112" name="n112">112</a>
<a href="https://stripe-ctf.com/levels/8#n113" name="n113">113</a>
<a href="https://stripe-ctf.com/levels/8#n114" name="n114">114</a>
<a href="https://stripe-ctf.com/levels/8#n115" name="n115">115</a>
<a href="https://stripe-ctf.com/levels/8#n116" name="n116">116</a>
<a href="https://stripe-ctf.com/levels/8#n117" name="n117">117</a>
<a href="https://stripe-ctf.com/levels/8#n118" name="n118">118</a>
<a href="https://stripe-ctf.com/levels/8#n119" name="n119">119</a>
<strong><a href="https://stripe-ctf.com/levels/8#n120" name="n120">120</a></strong>
<a href="https://stripe-ctf.com/levels/8#n121" name="n121">121</a>
<a href="https://stripe-ctf.com/levels/8#n122" name="n122">122</a>
<a href="https://stripe-ctf.com/levels/8#n123" name="n123">123</a>
<a href="https://stripe-ctf.com/levels/8#n124" name="n124">124</a>
<a href="https://stripe-ctf.com/levels/8#n125" name="n125">125</a>
<a href="https://stripe-ctf.com/levels/8#n126" name="n126">126</a>
<a href="https://stripe-ctf.com/levels/8#n127" name="n127">127</a>
<a href="https://stripe-ctf.com/levels/8#n128" name="n128">128</a>
<a href="https://stripe-ctf.com/levels/8#n129" name="n129">129</a>
<strong><a href="https://stripe-ctf.com/levels/8#n130" name="n130">130</a></strong>
<a href="https://stripe-ctf.com/levels/8#n131" name="n131">131</a>
<a href="https://stripe-ctf.com/levels/8#n132" name="n132">132</a>
<a href="https://stripe-ctf.com/levels/8#n133" name="n133">133</a>
<a href="https://stripe-ctf.com/levels/8#n134" name="n134">134</a>
<a href="https://stripe-ctf.com/levels/8#n135" name="n135">135</a>
<a href="https://stripe-ctf.com/levels/8#n136" name="n136">136</a>
<a href="https://stripe-ctf.com/levels/8#n137" name="n137">137</a>
<a href="https://stripe-ctf.com/levels/8#n138" name="n138">138</a>
<a href="https://stripe-ctf.com/levels/8#n139" name="n139">139</a>
<strong><a href="https://stripe-ctf.com/levels/8#n140" name="n140">140</a></strong>
<a href="https://stripe-ctf.com/levels/8#n141" name="n141">141</a>
<a href="https://stripe-ctf.com/levels/8#n142" name="n142">142</a>
<a href="https://stripe-ctf.com/levels/8#n143" name="n143">143</a>
<a href="https://stripe-ctf.com/levels/8#n144" name="n144">144</a>
<a href="https://stripe-ctf.com/levels/8#n145" name="n145">145</a>
<a href="https://stripe-ctf.com/levels/8#n146" name="n146">146</a>
<a href="https://stripe-ctf.com/levels/8#n147" name="n147">147</a>
<a href="https://stripe-ctf.com/levels/8#n148" name="n148">148</a>
<a href="https://stripe-ctf.com/levels/8#n149" name="n149">149</a>
<strong><a href="https://stripe-ctf.com/levels/8#n150" name="n150">150</a></strong>
<a href="https://stripe-ctf.com/levels/8#n151" name="n151">151</a>
<a href="https://stripe-ctf.com/levels/8#n152" name="n152">152</a>
<a href="https://stripe-ctf.com/levels/8#n153" name="n153">153</a>
<a href="https://stripe-ctf.com/levels/8#n154" name="n154">154</a>
<a href="https://stripe-ctf.com/levels/8#n155" name="n155">155</a>
<a href="https://stripe-ctf.com/levels/8#n156" name="n156">156</a>
<a href="https://stripe-ctf.com/levels/8#n157" name="n157">157</a>
<a href="https://stripe-ctf.com/levels/8#n158" name="n158">158</a>
<a href="https://stripe-ctf.com/levels/8#n159" name="n159">159</a>
<strong><a href="https://stripe-ctf.com/levels/8#n160" name="n160">160</a></strong>
<a href="https://stripe-ctf.com/levels/8#n161" name="n161">161</a>
<a href="https://stripe-ctf.com/levels/8#n162" name="n162">162</a>
<a href="https://stripe-ctf.com/levels/8#n163" name="n163">163</a>
<a href="https://stripe-ctf.com/levels/8#n164" name="n164">164</a>
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">atexit</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">json</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">logging</span>
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">os</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">twisted.internet</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">reactor</span>, <span style="color:#B44;font-weight:bold">protocol</span>
<span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">twisted.protocols</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">basic</span>

<span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">twisted.web</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">server</span>, <span style="color:#B44;font-weight:bold">resource</span>, <span style="color:#B44;font-weight:bold">client</span>

logger = logging.getLogger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">password_db.common</span><span style="color:#710">'</span></span>)


<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Halt</span>(<span style="color:#C00;font-weight:bold">Exception</span>):
    <span style="color:#080;font-weight:bold">pass</span>


<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">HTTPServer</span>(<span style="color:#369;font-weight:bold">object</span>, resource.Resource):
    isLeaf = <span style="color:#069">True</span>

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">__init__</span>(<span style="color:#069">self</span>, processor, args):
        <span style="color:#069">self</span>.processor = processor
        <span style="color:#069">self</span>.args = args

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">render_GET</span>(<span style="color:#069">self</span>, request):
        <span style="color:#080;font-weight:bold">return</span> (<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">{"success": false, "message": "GET not supported.</span><span style="color:#710">'</span></span>
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> Try POSTing instead."}</span><span style="color:#b0b">\n</span><span style="color:#710">'</span></span>)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">render_POST</span>(<span style="color:#069">self</span>, request):
        processor_instance = <span style="color:#069">self</span>.processor(request, <span style="color:#069">self</span>.args)
        processor_instance.processRaw()
        <span style="color:#080;font-weight:bold">return</span> server.NOT_DONE_YET

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PayloadProcessor</span>(<span style="color:#369;font-weight:bold">object</span>):
    request_count = <span style="color:#00D">0</span>

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">__init__</span>(<span style="color:#069">self</span>, request):
        PayloadProcessor.request_count += <span style="color:#00D">1</span>
        <span style="color:#069">self</span>.request_id = PayloadProcessor.request_count
        <span style="color:#069">self</span>.request = request

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">processRaw</span>(<span style="color:#069">self</span>):
        raw_data = <span style="color:#069">self</span>.request.content.read()
        <span style="color:#069">self</span>.log_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Received payload: %r</span><span style="color:#710">'</span></span>, raw_data)

        <span style="color:#080;font-weight:bold">try</span>:
            parsed = json.loads(raw_data)
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#C00;font-weight:bold">ValueError</span> <span style="color:#080;font-weight:bold">as</span> e:
            <span style="color:#069">self</span>.respondWithMessage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Could not parse message: %s</span><span style="color:#710">'</span></span> % e)
            <span style="color:#080;font-weight:bold">return</span>

        <span style="color:#080;font-weight:bold">try</span>:
            <span style="color:#069">self</span>.process(parsed)
        <span style="color:#080;font-weight:bold">except</span> Halt:
            <span style="color:#080;font-weight:bold">pass</span>

    <span style="color:#777"># API method</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">process</span>(<span style="color:#069">self</span>, data):
        <span style="color:#080;font-weight:bold">raise</span> <span style="color:#C00;font-weight:bold">NotImplementedError</span>

    <span style="color:#777"># Utility methods</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">getArg</span>(<span style="color:#069">self</span>, data, name):
        <span style="color:#080;font-weight:bold">try</span>:
            <span style="color:#080;font-weight:bold">return</span> data[name]
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#C00;font-weight:bold">KeyError</span>:
            <span style="color:#069">self</span>.respondWithMessage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Missing required param: %s</span><span style="color:#710">'</span></span> % name)
            <span style="color:#080;font-weight:bold">raise</span> Halt()

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">respondWithMessage</span>(<span style="color:#069">self</span>, message):
        response = {
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">success</span><span style="color:#710">'</span></span> : <span style="color:#069">False</span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">message</span><span style="color:#710">'</span></span> : message
            }
        <span style="color:#069">self</span>.respond(response)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">respond</span>(<span style="color:#069">self</span>, response):
        <span style="color:#080;font-weight:bold">if</span> <span style="color:#069">self</span>.request.notifyFinish():
            <span style="color:#069">self</span>.log_error(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Request already finished!</span><span style="color:#710">"</span></span>)
        formatted = json.dumps(response) + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#b0b">\n</span><span style="color:#710">'</span></span>
        <span style="color:#069">self</span>.log_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Responding with: %r</span><span style="color:#710">'</span></span>, formatted)
        <span style="color:#069">self</span>.request.write(formatted)
        <span style="color:#069">self</span>.request.finish()

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">log_info</span>(<span style="color:#069">self</span>, *args):
        <span style="color:#069">self</span>.log(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">info</span><span style="color:#710">'</span></span>, *args)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">log_error</span>(<span style="color:#069">self</span>, *args):
        <span style="color:#069">self</span>.log(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">error</span><span style="color:#710">'</span></span>, *args)

    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">log</span>(<span style="color:#069">self</span>, level, msg, *args):
        <span style="color:#777"># Make this should actually be handled by a formatter.</span>
        client = <span style="color:#069">self</span>.request.client
        <span style="color:#080;font-weight:bold">try</span>:
            host = client.host
            port = client.port
        <span style="color:#080;font-weight:bold">except</span> <span style="color:#C00;font-weight:bold">AttributeError</span>:
            prefix = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">[%r:%d] </span><span style="color:#710">'</span></span>  % (client, <span style="color:#069">self</span>.request_id)
        <span style="color:#080;font-weight:bold">else</span>:
            prefix = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">[%s:%d:%d] </span><span style="color:#710">'</span></span>  % (host, port, <span style="color:#069">self</span>.request_id)
        method = <span style="color:#369;font-weight:bold">getattr</span>(logger, level)
        interpolated = msg % args
        method(prefix + interpolated)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">chunkPassword</span>(chunk_count, password, request=<span style="color:#069">None</span>):
    <span style="color:#777"># Equivalent to ceil(password_length / chunk_count)</span>
    chunk_size = (<span style="color:#369;font-weight:bold">len</span>(password) + chunk_count - <span style="color:#00D">1</span>) / chunk_count

    chunks = []
    <span style="color:#080;font-weight:bold">for</span> i <span style="color:#080;font-weight:bold">in</span> <span style="color:#369;font-weight:bold">xrange</span>(<span style="color:#00D">0</span>, <span style="color:#369;font-weight:bold">len</span>(password), chunk_size):
        chunks.append(password[i:i+chunk_size])

    <span style="color:#080;font-weight:bold">while</span> <span style="color:#369;font-weight:bold">len</span>(chunks) &lt; chunk_count:
        chunks.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>)

    msg = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Split length %d password into %d chunks of size about %d: %r</span><span style="color:#710">'</span></span>
    args = [<span style="color:#369;font-weight:bold">len</span>(password), chunk_count, chunk_size, chunks]
    <span style="color:#080;font-weight:bold">if</span> request:
        request.log_info(msg, *args)
    <span style="color:#080;font-weight:bold">else</span>:
        logger.info(msg, *args)

    <span style="color:#080;font-weight:bold">return</span> chunks

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">isUnix</span>(spec):
    <span style="color:#080;font-weight:bold">return</span> spec.startswith(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">unix:</span><span style="color:#710">'</span></span>)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">parseHost</span>(host):
    host, port = host.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">:</span><span style="color:#710">'</span></span>)
    port = <span style="color:#369;font-weight:bold">int</span>(port)
    <span style="color:#080;font-weight:bold">return</span> host, port

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">parseUnix</span>(unix):
    path = unix[<span style="color:#369;font-weight:bold">len</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">unix:</span><span style="color:#710">'</span></span>):]
    <span style="color:#080;font-weight:bold">return</span> path

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">makeRequest</span>(address_spec, data, callback, errback):
    <span style="color:#777"># Change the signature of the errback</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">wrapper</span>(error):
        errback(address_spec, error)

    host, port = address_spec
    factory = client.HTTPClientFactory(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>,
                                       agent=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">PasswordChunker</span><span style="color:#710">'</span></span>,
                                       method=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">POST</span><span style="color:#710">'</span></span>,
                                       postdata=json.dumps(data))
    factory.deferred.addCallback(callback)
    factory.deferred.addErrback(wrapper)
    reactor.connectTCP(host, port, factory)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">listenTCP</span>(address_spec, http_server):
    host, port = address_spec
    site = server.Site(http_server)
    reactor.listenTCP(port, site, <span style="color:#00D">50</span>, host)

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">cleanupSocket</span>(path):
    <span style="color:#080;font-weight:bold">try</span>:
        os.remove(path)
    <span style="color:#080;font-weight:bold">except</span> <span style="color:#C00;font-weight:bold">OSError</span>:
        <span style="color:#080;font-weight:bold">pass</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">listenUNIX</span>(path, http_server):
    site = server.Site(http_server)
    reactor.listenUNIX(path, site, <span style="color:#00D">50</span>)
    atexit.register(cleanupSocket, path)
</pre></td>
</tr></tbody></table>

  </code>
</div>

</div>


    <div id="footer">
      <p>:(){ :|:&amp; };:</p>

      <a href="https://stripe-ctf.com/about">About</a>
      <a href="https://stripe.com/">Stripe</a>
      <a href="https://stripe.com/jobs">Jobs</a>
    </div>




<div id="menu_item" class="jjMenuItemDiv">Copy without formatting</div><div style="display: none; " id="hiddenlpsubmitdiv"></div><script>try{for(var lastpass_iter=0; lastpass_iter < document.forms.length; lastpass_iter++){ var lastpass_f = document.forms[lastpass_iter]; if(typeof(lastpass_f.lpsubmitorig2)=="undefined"){ lastpass_f.lpsubmitorig2 = lastpass_f.submit; lastpass_f.submit = function(){ var form=this; var customEvent = document.createEvent("Event"); customEvent.initEvent("lpCustomEvent", true, true); var d = document.getElementById("hiddenlpsubmitdiv"); for(var i = 0; i < document.forms.length; i++){ if(document.forms[i]==form){ d.innerText=i; } } d.dispatchEvent(customEvent); form.lpsubmitorig2(); } } }}catch(e){}</script></body></html>